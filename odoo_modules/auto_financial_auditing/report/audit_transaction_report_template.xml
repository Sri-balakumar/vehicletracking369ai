<?xml version="1.0" encoding="utf-8"?>
<odoo>
<template id="report_audit_transaction_template">
    <t t-call="web.html_container">
        <t t-foreach="docs" t-as="o">
            <!-- Safe currency fallback: avoids 'Expected singleton' crash -->
            <t t-set="currency" t-value="o.currency_id or o.company_id.currency_id or env.company.currency_id"/>
            <t t-call="web.external_layout">
                <div class="page">
                    <!-- Header -->
                    <div class="row" style="border-bottom: 3px solid #1B4F72; padding-bottom: 10px; margin-bottom: 20px;">
                        <div class="col-7">
                            <h2 style="color: #1B4F72; margin:0;">TRANSACTION AUDIT VOUCHER</h2>
                            <p class="text-muted" style="margin:0;">Auto Financial Auditing</p>
                            <div style="margin-top:8px;">
                                <span t-field="o.state"
                                      t-options="{'widget': 'badge'}"
                                      style="font-size: 14px;"/>
                            </div>
                        </div>
                        <div class="col-5 text-right">
                            <t t-if="o.qr_code_img">
                                <img t-att-src="image_data_uri(o.qr_code_img)"
                                     style="width:90px; height:90px; border:1px solid #dee2e6; padding:2px; background:#fff;"/>
                                <p style="font-size:8px; color:#888; margin:2px 0 0 0;">Scan to verify</p>
                            </t>
                        </div>
                    </div>

                    <!-- Transaction Info -->
                    <table class="table table-sm" style="margin-bottom:20px;">
                        <thead style="background:#1B4F72; color:white;">
                            <tr>
                                <th colspan="4" class="text-center">TRANSACTION INFORMATION</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="width:25%; font-weight:bold;">1. Transaction Ref</td>
                                <td style="width:25%;">
                                    <span t-field="o.transaction_ref"/>
                                </td>
                                <td style="width:25%; font-weight:bold;">Transaction Date</td>
                                <td><span t-field="o.transaction_date"/></td>
                            </tr>
                            <tr>
                                <td style="font-weight:bold;">2. Account Type</td>
                                <td><span t-field="o.audit_account_type"/></td>
                                <td style="font-weight:bold;">Journal</td>
                                <td><span t-field="o.journal_id"/></td>
                            </tr>
                            <tr>
                                <td style="font-weight:bold;">3. Partner</td>
                                <td><span t-field="o.partner_id"/></td>
                                <td style="font-weight:bold;">Company</td>
                                <td><span t-field="o.company_id"/></td>
                            </tr>
                            <tr>
                                <td style="font-weight:bold;">4. Amount (excl. tax)</td>
                                <td>
                                    <span t-field="o.amount_untaxed"
                                          t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                                </td>
                                <td style="font-weight:bold;" t-if="o.has_tax">5. Tax Amount</td>
                                <td t-if="o.has_tax">
                                    <span t-field="o.amount_tax"
                                          t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                                </td>
                            </tr>
                            <tr style="background:#f8f9fa; font-weight:bold;">
                                <td>6. TOTAL AMOUNT</td>
                                <td colspan="3">
                                    <span t-field="o.amount_total"
                                          t-options="{'widget': 'monetary', 'display_currency': currency}"
                                          style="font-size:16px; color:#1B4F72;"/>
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight:bold;">7. Salesperson / Creator</td>
                                <td><span t-field="o.salesperson_id"/></td>
                                <td style="font-weight:bold;">Created By</td>
                                <td><span t-field="o.created_by"/></td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Invoice Reference Barcode -->
                    <t t-if="o.barcode_img">
                        <div style="text-align:center; margin:12px 0 16px 0;">
                            <img t-att-src="image_data_uri(o.barcode_img)"
                                 style="height:65px; max-width:380px;"/>
                            <p style="font-size:8px; color:#888; margin:2px 0 0 0; letter-spacing:0.5px;">
                                INVOICE REFERENCE BARCODE
                            </p>
                        </div>
                    </t>

                    <!-- Transaction Lines -->
                    <t t-if="o.audit_line_ids">
                        <h5 style="color:#1B4F72; border-bottom:2px solid #1B4F72; padding-bottom:5px;">
                            Transaction Line Details
                        </h5>
                        <table class="table table-sm table-bordered" style="margin-bottom:20px; font-size:11px;">
                            <thead style="background:#e8eaf6;">
                                <tr>
                                    <th>Product</th>
                                    <th>Description</th>
                                    <th class="text-right">Qty</th>
                                    <th class="text-right">Unit Price</th>
                                    <th class="text-right">Tax</th>
                                    <th class="text-right">Subtotal</th>
                                    <th>Account</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="o.audit_line_ids" t-as="line">
                                    <tr>
                                        <td><span t-field="line.product_id"/></td>
                                        <td><span t-field="line.name"/></td>
                                        <td class="text-right"><span t-field="line.quantity"/></td>
                                        <td class="text-right">
                                            <span t-field="line.price_unit"
                                                  t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                                        </td>
                                        <td class="text-right">
                                            <span t-field="line.tax_amount"
                                                  t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                                        </td>
                                        <td class="text-right">
                                            <span t-field="line.subtotal"
                                                  t-options="{'widget': 'monetary', 'display_currency': currency}"/>
                                        </td>
                                        <td><span t-field="line.account_id"/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </t>

                    <!-- Signatures Section -->
                    <h5 style="color:#1B4F72; border-bottom:2px solid #1B4F72; padding-bottom:5px; margin-top:30px;">
                        Signatures &amp; Verification
                    </h5>
                    <div class="row" style="margin-top:20px;">
                        <!-- Customer Signature -->
                        <div class="col-6" style="border-right: 1px solid #dee2e6; padding-right:30px;">
                            <h6 style="font-weight:bold; color:#1B4F72;">8. Customer Signature</h6>
                            <div style="border: 1px dashed #aaa; height: 80px; margin:10px 0; text-align:center; background:#f8f9fa; display:flex; align-items:center; justify-content:center;">
                                <t t-if="o.customer_signature">
                                    <img t-att-src="image_data_uri(o.customer_signature)"
                                         style="max-height:70px; max-width:100%;"/>
                                </t>
                                <t t-else="">
                                    <span class="text-muted" style="font-size:11px;">Signature Pending</span>
                                </t>
                            </div>
                            <p style="margin:5px 0; font-size:11px;">
                                <strong>Name:</strong>
                                <span t-field="o.customer_signed_by"/>
                            </p>
                            <p style="margin:5px 0; font-size:11px;">
                                <strong>Date:</strong>
                                <span t-field="o.customer_signed_date"/>
                            </p>
                        </div>
                        <!-- Cashier Signature -->
                        <div class="col-6" style="padding-left:30px;">
                            <h6 style="font-weight:bold; color:#1B4F72;">9. Cashier Signature</h6>
                            <div style="border: 1px dashed #aaa; height: 80px; margin:10px 0; text-align:center; background:#f8f9fa; display:flex; align-items:center; justify-content:center;">
                                <t t-if="o.cashier_signature">
                                    <img t-att-src="image_data_uri(o.cashier_signature)"
                                         style="max-height:70px; max-width:100%;"/>
                                </t>
                                <t t-else="">
                                    <span class="text-muted" style="font-size:11px;">Signature Pending</span>
                                </t>
                            </div>
                            <p style="margin:5px 0; font-size:11px;">
                                <strong>Name:</strong>
                                <span t-field="o.cashier_signed_by"/>
                            </p>
                            <p style="margin:5px 0; font-size:11px;">
                                <strong>Date:</strong>
                                <span t-field="o.cashier_signed_date"/>
                            </p>
                        </div>
                    </div>

                    <!-- Footer note -->
                    <div style="margin-top:30px; padding:10px; background:#fff8e1; border-left:4px solid #f9a825; font-size:10px;">
                        <strong>Audit Note:</strong> This voucher certifies that the above transaction
                        has been verified by both the customer and cashier. The financial data shown
                        is fetched directly from the Odoo database without manual re-entry to ensure
                        accuracy and prevent fraud.
                    </div>
                </div>
            </t>
        </t>
    </t>
</template>
</odoo>
